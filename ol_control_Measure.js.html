<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ol/control/Measure.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ol/control/Measure.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module webgis4u/ol/control/Measure
 */

import Control from 'ol/control/Control';
import LineString from 'ol/geom/LineString';
import Polygon from 'ol/geom/Polygon';
import VectorLayer from 'ol/layer/Vector';
import Draw from 'ol/interaction/Draw';
import VectorSource from 'ol/source/Vector';

import { createElement } from '../../util/dom/createElement';
import { formatUnitValue } from '../../util/string';
import { reproject } from '../proj/reproject';
import { MODIFY_FILL, MODIFY_STROKE, SELECT_STROKE, SELECT_FILL } from '../style/color';
import { getStyle } from '../style/style';

import { CSS_CONTROL_PREFIX } from './common';

import './Measure/Measure.scss';
import { EPSG31287_ID } from '../proj/austria';

/**
 * Enum describing the measurement type.
 * @readonly
 * @enum {string}
 */
export const MeasurementTypeEnum = {
  /** Area */
  Area: 'area',
  /** Distance */
  Distance: 'distance',
};

const DFEAULT_MEASUREMENT_TYPE = MeasurementTypeEnum.Distance;

/**
 * The CSS class for the contorl
 */
export const CSS_CLASS = `${CSS_CONTROL_PREFIX}-measure-output`;

/**
 * @param {MeasurementTypeEnum} measurementType The interaction type
 * @returns {ol.geom.GeometryType}
 */
function GetClassForType(measurementType) {
  switch (measurementType) {
    case MeasurementTypeEnum.Area: return 'Polygon';
    case MeasurementTypeEnum.Distance: return 'LineString';
    default: throw new Error('Unsupported type');
  }
}

/**
 * @param {MeasurementTypeEnum} value The value
 * @returns {MeasurementTypeEnum} The passed value or the default type
 */
function getMeasurementTypeOrDefault(value) {
  const keys = Object.keys(MeasurementTypeEnum);
  const result = keys.find(key => MeasurementTypeEnum[key] === value);

  return (result)
    ? value
    : DFEAULT_MEASUREMENT_TYPE;
}

/**
 * Control for measuring
 */
class Measure extends Control {
  /**
   * The limit above the distance is displayed in km (default &lt; 1000). You can
   * override it with your individual value if necessary.
   * @type {integer}
   */
  static limit4m = 1000;

  /**
   * The limit when the area is displayed in km2 (default &lt; 1000000). You can
   * override it with your individual value if necessary.
   * @type {integer}
   */
  static limit4m2 = 1000000;

  /**
   * The type
   * @type {string}
   */
  measurementType_ = DFEAULT_MEASUREMENT_TYPE;

  /**
   * The old map
   * @type {ol.Map|null}
   */
  oldMap_ = null;

  constructor(options) {
    const element = createElement({
      tag: 'div',
      cssClass: CSS_CLASS,
    });

    super({
      element,
      ...options,
    });

    const source = new VectorSource();
    this.vector = new VectorLayer({
      source,
      style: getStyle(3, 6, SELECT_STROKE, SELECT_FILL, this.lineDash),
    });

    const initialMeasurementType = options &amp;&amp; options.type;
    this.measurementType_ = getMeasurementTypeOrDefault(initialMeasurementType);
  }

  /**
   * @returns {MeasurementTypeEnum} the current type
   */
  get measurementType() { return this.measurementType_; }

  /**
   * Sets a new type
   * @param {MeasurementTypeEnum} value The type
   */
  set measurementType(value) {
    this.measurementType_ = getMeasurementTypeOrDefault(value);
    this.addInteraction(this.measurementType_);
  }

  /**
   * @returns {MeasurementTypeEnum} the current type
   */
  getType() { return this.measurementType; }

  /**
   * Sets a new type
   * @param {MeasurementTypeEnum} value The type
   */
  setType(value) { this.measurementType = value; }

  /**
   * @inheritdoc
   */
  setMap(map) {
    // Clean up if an old map exists
    if (this.oldMap_) {
      /* remove all measure interactions (if any) */
      this.vector.getSource().clear();
      this.oldMap_.removeLayer(this.vector);
      this.oldMap_.removeInteraction(this.draw);
      this.oldMap_.un('pointermove', this.handleMeasurementShouldUpdate);

      this.toggleElement(false);
    }

    this.oldMap_ = map;
    if (map) {
      this.measurementType = this.measurementType;
      this.oldMap_.addLayer(this.vector);
      this.oldMap_.on('pointermove', this.handleMeasurementShouldUpdate);
    }

    super.setMap(map);
  }

  /**
   * Toggles the elements visibility
   * @param {boolean} isVisible If `true`, the element will be displayed
   *
   * @private
   */
  toggleElement(isVisible) {
    const { element } = this;

    if (!element) { return; }
    element.setAttribute('data-visible', isVisible);
  }

  handleMeasurementShouldUpdate = () => {
    this.updateMeasurement();
  }

  /**
   * Updates the measurement
   *
   * @private
   */
  updateMeasurement() {
    if (!this.sketch) { return; }
    const geom = this.sketch.getGeometry();
    if (!geom) { return; }

    const sourceProjection = this.oldMap_.getView().getProjection().getCode();
    const reprojected = reproject(geom, sourceProjection, EPSG31287_ID);

    let text = '';
    if (geom instanceof Polygon) {
      text = this.displayArea(reprojected.getArea());
    } else if (geom instanceof LineString) {
      text = this.displayLength(reprojected.getLength());
    }

    this.element.innerHTML = text;
  }

  /**
   * Add the interaction
   * @param {MeasurementTypeEnum} measurementType
   *
   * @private
   */
  addInteraction(measurementType) {
    const typeConstructor = GetClassForType(measurementType);

    this.draw = new Draw({
      source: this.source,
      type: typeConstructor,
      style: getStyle(3, 6, MODIFY_STROKE, MODIFY_FILL, this.lineDash),
    });

    this.oldMap_.addInteraction(this.draw);
    this.draw.on('drawstart', this.onDrawStart);
    this.draw.on('drawend', this.onDrawEnd);
  }

  /**
   * Event handler for the draw start event
   * @private
   */
  onDrawStart = (evt) => {
    // set sketch
    this.sketch = evt.feature;
    this.toggleElement(true);
  }

  /**
   * Event handler for the draw end event
   * @private
   */
  onDrawEnd = () => {
    // unset sketch
    this.sketch = null;
  }

  /**
   * Formats the length output.
   * @param {ol.geom.LineString} length The length in m
   * @return {string} The formated length.
   *
   * @private
   */
  displayLength(length) {
    const formatedUnitValue = formatUnitValue({
      value: length,
      decimals: 2,
      units: [
        { abbreviation: 'm' },
        { abbreviation: 'km', factor: 1000, limit: Measure.limit4m },
      ],
    });

    return `L&amp;auml;nge: ${formatedUnitValue}`;
  }

  /**
   * Formats the area output.
   * @param {number} area The area.
   * @returns {string} The formated area.
   *
   * @private
   */
  displayArea(area) {
    const formatedUnitValue = formatUnitValue({
      value: area,
      decimals: 2,
      units: [
        { abbreviation: 'm&lt;sup>2&lt;/sup>' },
        { abbreviation: 'km&lt;sup>2&lt;/sup>', factor: 1000000, limit: Measure.limit4m2 },
      ],
    });

    return `Fl&amp;auml;che: ${formatedUnitValue}`;
  }
}

export default Measure;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-webgis4u.html">webgis4u</a></li><li><a href="module-webgis4u_components.html">webgis4u/components</a></li><li><a href="module-webgis4u_components_AutoComplete.html">webgis4u/components/AutoComplete</a></li><li><a href="module-webgis4u_ol.html">webgis4u/ol</a></li><li><a href="module-webgis4u_ol_common.html">webgis4u/ol/common</a></li><li><a href="module-webgis4u_ol_control.html">webgis4u/ol/control</a></li><li><a href="module-webgis4u_ol_control_AbstractLayerRelatedControl.html">webgis4u/ol/control/AbstractLayerRelatedControl</a></li><li><a href="module-webgis4u_ol_control_AbstractLayerRelatedElementControl.html">webgis4u/ol/control/AbstractLayerRelatedElementControl</a></li><li><a href="module-webgis4u_ol_control_common.html">webgis4u/ol/control/common</a></li><li><a href="module-webgis4u_ol_control_HtmlTemplate.html">webgis4u/ol/control/HtmlTemplate</a></li><li><a href="module-webgis4u_ol_control_HtmlTemplate_InfoPanel.html">webgis4u/ol/control/HtmlTemplate/InfoPanel</a></li><li><a href="module-webgis4u_ol_control_HtmlTemplate_ToolSwitcher.html">webgis4u/ol/control/HtmlTemplate/ToolSwitcher</a></li><li><a href="module-webgis4u_ol_control_LayerCheckbox.html">webgis4u/ol/control/LayerCheckbox</a></li><li><a href="module-webgis4u_ol_control_LayerRadioButton.html">webgis4u/ol/control/LayerRadioButton</a></li><li><a href="module-webgis4u_ol_control_LegendDisplayable.html">webgis4u/ol/control/LegendDisplayable</a></li><li><a href="module-webgis4u_ol_control_LegendVisibility.html">webgis4u/ol/control/LegendVisibility</a></li><li><a href="module-webgis4u_ol_control_Measure.html">webgis4u/ol/control/Measure</a></li><li><a href="module-webgis4u_ol_control_OverviewMap.html">webgis4u/ol/control/OverviewMap</a></li><li><a href="module-webgis4u_ol_control_PanBar.html">webgis4u/ol/control/PanBar</a></li><li><a href="module-webgis4u_ol_control_ScaleLine.html">webgis4u/ol/control/ScaleLine</a></li><li><a href="module-webgis4u_ol_control_Search.html">webgis4u/ol/control/Search</a></li><li><a href="module-webgis4u_ol_control_util.html">webgis4u/ol/control/util</a></li><li><a href="module-webgis4u_ol_proj.html">webgis4u/ol/proj</a></li><li><a href="module-webgis4u_ol_proj_austria.html">webgis4u/ol/proj/austria</a></li><li><a href="module-webgis4u_ol_proj_reproject.html">webgis4u/ol/proj/reproject</a></li><li><a href="module-webgis4u_ol_source.html">webgis4u/ol/source</a></li><li><a href="module-webgis4u_ol_source_basemap.html">webgis4u/ol/source/basemap</a></li><li><a href="module-webgis4u_ol_source_basemap_common.html">webgis4u/ol/source/basemap/common</a></li><li><a href="module-webgis4u_ol_style.html">webgis4u/ol/style</a></li><li><a href="module-webgis4u_ol_style_color.html">webgis4u/ol/style/color</a></li><li><a href="module-webgis4u_ol_style_style.html">webgis4u/ol/style/style</a></li><li><a href="module-webgis4u_ol_util.html">webgis4u/ol/util</a></li><li><a href="module-webgis4u_ol_util_changeMapTarget.html">webgis4u/ol/util/changeMapTarget</a></li><li><a href="module-webgis4u_ol_util_createImageFromMap.html">webgis4u/ol/util/createImageFromMap</a></li><li><a href="module-webgis4u_ol_util_getMapChildElementByClassName.html">webgis4u/ol/util/getMapChildElementByClassName</a></li><li><a href="module-webgis4u_ol_util_getMapType.html">webgis4u/ol/util/getMapType</a></li><li><a href="module-webgis4u_ol_util_getScale.html">webgis4u/ol/util/getScale</a></li><li><a href="module-webgis4u_ol_util_pan.html">webgis4u/ol/util/pan</a></li><li><a href="module-webgis4u_ol_util_print.html">webgis4u/ol/util/print</a></li><li><a href="module-webgis4u_ol_util_zoomToExtent.html">webgis4u/ol/util/zoomToExtent</a></li><li><a href="module-webgis4u_ol_util_zoomToLayerExtent.html">webgis4u/ol/util/zoomToLayerExtent</a></li><li><a href="module-webgis4u_util.html">webgis4u/util</a></li><li><a href="module-webgis4u_util_dom.html">webgis4u/util/dom</a></li><li><a href="module-webgis4u_util_dom_createElement.html">webgis4u/util/dom/createElement</a></li><li><a href="module-webgis4u_util_dom_KeyCodeEnum.html">webgis4u/util/dom/KeyCodeEnum</a></li><li><a href="module-webgis4u_util_dom_toggleElement.html">webgis4u/util/dom/toggleElement</a></li><li><a href="module-webgis4u_util_function.html">webgis4u/util/function</a></li><li><a href="module-webgis4u_util_function_debounce.html">webgis4u/util/function/debounce</a></li><li><a href="module-webgis4u_util_number.html">webgis4u/util/number</a></li><li><a href="module-webgis4u_util_number_convertUnitValue.html">webgis4u/util/number/convertUnitValue</a></li><li><a href="module-webgis4u_util_promise.html">webgis4u/util/promise</a></li><li><a href="module-webgis4u_util_promise_asyncDebounce.html">webgis4u/util/promise/asyncDebounce</a></li><li><a href="module-webgis4u_util_promise_state.html">webgis4u/util/promise/state</a></li><li><a href="module-webgis4u_util_string.html">webgis4u/util/string</a></li><li><a href="module-webgis4u_util_string_formatNumber.html">webgis4u/util/string/formatNumber</a></li><li><a href="module-webgis4u_util_string_formatText.html">webgis4u/util/string/formatText</a></li><li><a href="module-webgis4u_util_string_formatUnitValue.html">webgis4u/util/string/formatUnitValue</a></li><li><a href="module-webgis4u_util_string_hasValue.html">webgis4u/util/string/hasValue</a></li><li><a href="module-webgis4u_util_web.html">webgis4u/util/web</a></li><li><a href="module-webgis4u_util_web_encodeQueryData.html">webgis4u/util/web/encodeQueryData</a></li><li><a href="module-webgis4u_util_web_sendRequest.html">webgis4u/util/web/sendRequest</a></li></ul><h3>Classes</h3><ul><li><a href="ClusterZoom.html">ClusterZoom</a></li><li><a href="module-webgis4u_components_AutoComplete-AutoComplete.html">AutoComplete</a></li><li><a href="module-webgis4u_ol_control_AbstractLayerRelatedControl-AbstractLayerRelatedControl.html">AbstractLayerRelatedControl</a></li><li><a href="module-webgis4u_ol_control_AbstractLayerRelatedElementControl-AbstractLayerRelatedElementControl.html">AbstractLayerRelatedElementControl</a></li><li><a href="module-webgis4u_ol_control_HtmlTemplate_InfoPanel-InfoPanel.html">InfoPanel</a></li><li><a href="module-webgis4u_ol_control_HtmlTemplate_ToolSwitcher-ToolSwitcher.html">ToolSwitcher</a></li><li><a href="module-webgis4u_ol_control_HtmlTemplate-HtmlTemplate.html">HtmlTemplate</a></li><li><a href="module-webgis4u_ol_control_LayerCheckbox-LayerCheckbox.html">LayerCheckbox</a></li><li><a href="module-webgis4u_ol_control_LayerRadioButton-LayerRadioButton.html">LayerRadioButton</a></li><li><a href="module-webgis4u_ol_control_LegendDisplayable-LegendDisplayable.html">LegendDisplayable</a></li><li><a href="module-webgis4u_ol_control_LegendVisibility-LegendVisibility.html">LegendVisibility</a></li><li><a href="module-webgis4u_ol_control_Measure-Measure.html">Measure</a></li><li><a href="module-webgis4u_ol_control_OverviewMap-OverviewMap.html">OverviewMap</a></li><li><a href="module-webgis4u_ol_control_PanBar-PanBar.html">PanBar</a></li><li><a href="module-webgis4u_ol_control_ScaleLine-ScaleLine.html">ScaleLine</a></li><li><a href="module-webgis4u_ol_control_Search-Search.html">Search</a></li><li><a href="module-webgis4u_ol_source_basemap.Color.html">Color</a></li><li><a href="module-webgis4u_ol_source_basemap.Gray.html">Gray</a></li><li><a href="module-webgis4u_ol_source_basemap.Orthofoto.html">Orthofoto</a></li><li><a href="module-webgis4u_ol_source_basemap.Overlay.html">Overlay</a></li></ul><h3>Global</h3><ul><li><a href="global.html#fromExtents">fromExtents</a></li><li><a href="global.html#fromFeatures">fromFeatures</a></li><li><a href="global.html#fromPixel">fromPixel</a></li><li><a href="global.html#getFeaturesAtPixel">getFeaturesAtPixel</a></li><li><a href="global.html#getFeaturesFromClusterFeature">getFeaturesFromClusterFeature</a></li><li><a href="global.html#getPseudoCenter">getPseudoCenter</a></li><li><a href="global.html#isDisplayable">isDisplayable</a></li><li><a href="global.html#isVisible">isVisible</a></li><li><a href="global.html#isVisibleForMap">isVisibleForMap</a></li><li><a href="global.html#isVisibleInView">isVisibleInView</a></li><li><a href="global.html#toggleInteraction">toggleInteraction</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Mon Dec 30 2019 11:39:34 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
