language: node_js
node_js:
  - "10"
cache:
  yarn: true
  directories:
    - "node_modules"

jobs:
  include:
    - stage: Test
      name: "Linting"
      script: "yarn lint"
    - script: yarn test:ci
      name: "Produce coverage"
    - stage: Build
      node_js: "10"
      name: "Webpack build"
      script: yarn build:ci
      before_deploy:
        #- git checkout -- packages/webgis4u-cli/src/main.js
        #- git checkout master
        - echo "//registry.npmjs.org/:_authToken=${NPM_API_KEY}" > ~/.npmrc
        #- git remote add pub https://christophka:${GH_TOKEN}@github.com/${TRAVIS_REPO_SLUG}.git
      deploy:
        provider: script
        # script: yarn deploy:ci --git-remote pub
        script: yarn deploy:ci
        skip_cleanup: true
        #if: tag =~ ^webgis4u(-.*)?@\d.\d.\d(-.*\.\d)?$
        on:
          all_branches: true
          #branch: master
          # this is how lerna sets up the branches (including versions with a preid)
          condition: $TRAVIS_TAG =~ ^webgis4u(-.*)?@\d.\d.\d(-.*\.\d)?$
    - stage: Docs
      name: "Generate docs"
      # Only generate docs for branch master
      if: branch = master
      script: yarn build:docs
      deploy:
        provider: pages
        skip-cleanup: true
        github-token: $GITHUB_TOKEN_GHPAGES
        local-dir: packages/webgis4u/doc
        on:
          branch: master

